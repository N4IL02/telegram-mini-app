<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>MASTER MINES BOT • mini app</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b1320;
      --panel:#0f1a2b;
      --panel-2:#101c30;
      --tile:#1991b3;
      --tile-deep:#0e6f8d;
      --glow:#35d0ff;
      --btn:#0a66ff;
      --btn-2:#0f79ff;
      --btn-text:#eaf6ff;
      --accent:#ff9933;
      --shadow:rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% -100px, #12233b 0%, var(--bg) 55%);
      color:#cfe8ff;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ——— Layout tuned for phones (9:16) ——— */
    .wrap{
      min-height:100dvh;
      padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
               max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      width:100%;
      max-width: 480px;              /* мобильный «холст» */
      background:linear-gradient(180deg, #0b1425, #0b1220);
      border:1px solid #12233d;
      border-radius:22px;
      box-shadow:0 40px 80px -20px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.02);
      padding:16px 16px 20px;
    }

    /* ——— Header ——— */
    .header{
      display:flex; align-items:center; gap:12px;
      padding:12px 12px; border-radius:16px;
      background:linear-gradient(180deg, #0f1b2f 0%, #0e182a 100%);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    }
    .header .avatar{
      width:52px;height:52px;border-radius:12px;object-fit:cover;
      flex:0 0 52px;
      box-shadow:0 0 0 6px rgba(53,208,255,.05), 0 10px 30px -6px rgba(53,208,255,.35)
    }
    .header-title{min-width:0; display:flex;flex-direction:column;gap:2px}
    .name{
      font-weight:800;
      /* авто-масштаб в диапазоне, чтобы не вылезал за рамки */
      font-size: clamp(16px, 5.2vw, 24px);
      letter-spacing:.2px;
      line-height:1.15;
      word-break: break-word;
    }
    .header-sub{opacity:.65; font-size:12px}

    /* ——— Menu ——— */
    .menu{
      margin-top:14px;
      background:linear-gradient(180deg, #0f1a2b, #0c1626);
      border:1px solid #132743;
      border-radius:16px;
      padding:12px;
    }
    .game-row{
      display:flex;align-items:center;gap:12px;
      padding:12px;border-radius:14px;
      background:linear-gradient(180deg, #0f1b2f, #0e182a);
      border:1px solid #142a48;
    }
    .game-row img.icon{
      width:60px;height:60px;border-radius:14px;object-fit:cover;flex:0 0 60px;
      box-shadow:0 0 0 6px rgba(53,208,255,.05), 0 10px 30px -6px rgba(53,208,255,.3)
    }
    .game-meta{flex:1; min-width:0}
    .game-meta .title{font-size: clamp(18px, 5vw, 22px); font-weight:800}
    .game-meta .sub{opacity:.7; font-size:13px}
    .primary{
      padding:12px 18px;border-radius:12px;border:none;cursor:pointer;
      font-weight:700;letter-spacing:.3px; font-size:14px;
      background:linear-gradient(180deg, var(--btn) 0%, var(--btn-2) 100%);
      color:var(--btn-text);
      box-shadow:0 14px 30px -10px rgba(13,104,255,.7), inset 0 0 0 1px rgba(255,255,255,.08);
      transition:transform .1s ease, filter .1s ease;
      flex:0 0 auto;
    }
    .primary:hover{filter:brightness(1.05)}
    .primary:active{transform:translateY(1px)}

    /* ——— Screens ——— */
    .screen{display:none}
    .screen.active{display:block}

    /* ——— Game ——— */
    .grid-wrap{
      margin-top:14px;
      background:radial-gradient(200px 120px at 50% -40px, #13233d 0%, #0b1425 60%);
      border:1px solid #132743; border-radius:20px; padding:18px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02), 0 30px 60px -20px rgba(0,0,0,.55);
    }
    .grid{
      --size:5;
      display:grid; grid-template-columns:repeat(var(--size), 1fr);
      gap:14px; padding:10px;
      background:linear-gradient(180deg, #0d1a2f, #0a1527);
      border-radius:18px; border:1px solid #122a48;
      box-shadow:inset 0 20px 40px -20px rgba(0,0,0,.9);
    }
    .cell{
      position:relative; aspect-ratio:1/1; border-radius:16px; overflow:hidden;
      background:radial-gradient(120% 120% at 50% 20%, var(--tile) 0%, var(--tile-deep) 70%);
      box-shadow:
        inset 0 -10px 18px -10px rgba(0,0,0,.6),
        inset 0 1px 0 rgba(255,255,255,.06),
        0 10px 26px -12px rgba(0,0,0,.6);
      border:1px solid rgba(255,255,255,.06);
    }
    .cell.safe{
      box-shadow:
        0 0 0 3px rgba(53,208,255,.42),
        0 14px 36px -14px rgba(53,208,255,.45),
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 -12px 22px -14px rgba(0,0,0,.7);
    }
    .cell.star::after{
      content:"";
      position:absolute; inset:18%;
      background: url("./star.png") center/contain no-repeat;
      filter: drop-shadow(0 8px 16px rgba(255,153,51,.35));
      pointer-events:none;
    }

    /* ——— Controls ——— */
    .controls{
      margin-top:12px; padding:14px;
      background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid #122a48; border-radius:16px;
      display:grid; grid-template-columns: 1fr; gap:12px;
      align-items:center;
    }
    .trap-picker{ display:flex; align-items:center; justify-content:center; gap:10px }
    .picker{
      width:100%; max-width:320px;
      display:grid; grid-template-columns:48px 1fr 48px; gap:10px; align-items:center;
    }
    .picker-btn{
      height:44px; border-radius:12px; border:1px solid #1b3761; background:#0e1c33;
      color:#cfe8ff; font-weight:800; font-size:18px; cursor:pointer;
    }
    .chip{
      height:44px; display:flex; align-items:center; justify-content:center;
      border-radius:12px; border:1px solid #1b3761; background:#0e1c33;
      color:#cfe8ff; font-weight:800; font-size:18px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }

    .play{
      width:100%; height:52px;
      border:none; border-radius:14px; cursor:pointer;
      font-weight:800; letter-spacing:.4px; font-size:16px;
      background:linear-gradient(180deg, #0b77ff 0%, #2b8bff 100%);
      color:var(--btn-text);
      box-shadow:0 16px 36px -12px rgba(43,139,255,.55), inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .back{
      width:100%; height:52px;
      border:none; border-radius:14px; cursor:pointer;
      background:linear-gradient(180deg, #b74b1f, #a43c11);
      color:#fff; font-weight:800; letter-spacing:.4px; font-size:16px;
      box-shadow:0 12px 28px -12px rgba(180,70,20,.6), inset 0 0 0 1px rgba(255,255,255,.06);
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- ——— MENU ——— -->
    <section id="screen-menu" class="screen active" aria-label="Main menu">
      <div class="header">
        <img class="avatar" src="bot-avatar.jpg" alt="Bot avatar" />
        <div class="header-title">
          <div class="name">@master_mines_bot</div>
          <div class="header-sub">MASTER MINES BOT • mini app</div>
        </div>
      </div>

      <div class="menu" style="margin-top:12px">
        <div class="game-row">
          <img class="icon" src="mines-icon.png" alt="Mines icon" />
          <div class="game-meta">
            <div class="title">Mines</div>
            <div class="sub">Classic 5×5 field</div>
          </div>
          <button class="primary" id="open-mines">Open</button>
        </div>
      </div>
    </section>

    <!-- ——— GAME ——— -->
    <section id="screen-game" class="screen" aria-label="Mines game">
      <div class="grid-wrap">
        <div id="grid" class="grid" aria-label="Mines grid 5x5"></div>
      </div>

      <div class="controls" aria-label="Controls">
        <!-- carousel 1–3–5–7 -->
        <div class="trap-picker">
          <div class="picker">
            <button id="prevTrap" class="picker-btn" aria-label="Prev traps">‹</button>
            <div id="trapValue" class="chip" aria-live="polite">3</div>
            <button id="nextTrap" class="picker-btn" aria-label="Next traps">›</button>
          </div>
        </div>

        <button id="btn-play" class="play" aria-label="Play prediction">Play</button>
        <button id="btn-back" class="back" aria-label="Back to menu">Back</button>
      </div>
    </section>

  </div>
</div>

<script>
  // ——— Telegram WebApp init ———
  (function initTG(){
    if (window.Telegram && Telegram.WebApp){
      const tg = Telegram.WebApp;
      try {
        tg.setBackgroundColor("#0b1320");
        tg.setHeaderColor("secondary_bg_color");
        tg.expand(); // use full height
        // обработка системной «назад»
        tg.BackButton.onClick(() => goMenu());
      } catch(e){}
    }
  })();

  // ——— Router ———
  const scrMenu = document.getElementById('screen-menu');
  const scrGame = document.getElementById('screen-game');

  function goGame(){
    scrMenu.classList.remove('active'); scrGame.classList.add('active');
    initGrid();
    if (Telegram?.WebApp) Telegram.WebApp.BackButton.show();
  }
  function goMenu(){
    scrGame.classList.remove('active'); scrMenu.classList.add('active');
    if (Telegram?.WebApp) Telegram.WebApp.BackButton.hide();
  }

  document.getElementById('open-mines').onclick = goGame;
  document.getElementById('btn-back').onclick = goMenu;

  // ——— Game state ———
  const gridEl = document.getElementById('grid');
  const SIZE = 5;
  let trapOptions = [1,3,5,7];
  let trapIndex = 1; // default '3'
  let cells = [];

  const trapValueEl = document.getElementById('trapValue');
  const prevTrap = document.getElementById('prevTrap');
  const nextTrap = document.getElementById('nextTrap');

  function renderTrapValue(){
    trapValueEl.textContent = trapOptions[trapIndex];
  }
  prevTrap.addEventListener('click', () => {
    trapIndex = (trapIndex - 1 + trapOptions.length) % trapOptions.length;
    renderTrapValue();
  });
  nextTrap.addEventListener('click', () => {
    trapIndex = (trapIndex + 1) % trapOptions.length;
    renderTrapValue();
  });
  renderTrapValue();

  function initGrid(){
    gridEl.innerHTML = '';
    cells = [];
    for (let i=0;i<SIZE*SIZE;i++){
      const c = document.createElement('div');
      c.className = 'cell';
      cells.push(c);
      gridEl.appendChild(c);
    }
  }

  // helper: shuffle & pick unique indices
  function pickUnique(total, count){
    const idx = Array.from({length:total}, (_,i)=>i);
    for (let i=idx.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [idx[i],idx[j]] = [idx[j],idx[i]];
    }
    return idx.slice(0,count);
  }

  // Play: generate traps, reveal safe stars
  document.getElementById('btn-play').addEventListener('click', () => {
    const trapCount = trapOptions[trapIndex];

    // clear previous
    cells.forEach(el => el.classList.remove('safe','star'));

    const total = SIZE*SIZE;
    const traps = new Set(pickUnique(total, trapCount));

    // safe = all except traps
    for (let i=0;i<total;i++){
      if (!traps.has(i)){
        cells[i].classList.add('safe','star'); // glow + star overlay
      }
    }
  });

  // first render
  initGrid();
</script>
</body>
</html>
